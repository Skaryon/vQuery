<pre><code class="lang-js"><span class="hljs-keyword">var</span> rendering = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> decodeEntities = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
</code></pre>
<p>this prevents any overhead from creating the object each time</p>
<pre><code class="lang-js">    <span class="hljs-keyword">var</span> element = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decodeHTMLEntities</span> (<span class="hljs-params">str</span>) </span>{
        <span class="hljs-keyword">if</span>(str &amp;&amp; <span class="hljs-keyword">typeof</span> str === <span class="hljs-string">'string'</span>) {
</code></pre>
<p>strip script/html tags</p>
<pre><code class="lang-js">            str = str.replace(<span class="hljs-regexp">/&lt;script[^&gt;]*&gt;([\S\s]*?)&lt;\/script&gt;/gmi</span>, <span class="hljs-string">''</span>);
            str = str.replace(<span class="hljs-regexp">/&lt;\/?\w(?:[^"'&gt;]|"[^"]*"|'[^']*')*&gt;/gmi</span>, <span class="hljs-string">''</span>);
            element.innerHTML = str;
            str = element.textContent;
            element.textContent = <span class="hljs-string">''</span>;
        }

        <span class="hljs-keyword">return</span> str;
    }

    <span class="hljs-keyword">return</span> decodeHTMLEntities;
})();
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createNode</span>(<span class="hljs-params">data</span>) </span>{
    <span class="hljs-built_in">var</span> node = <span class="hljs-built_in">document</span>.createElement(data.name);
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i <span class="hljs-keyword">in</span> data.attributes) {
        node.setAttribute(i, data.attributes[i]);
        <span class="hljs-keyword">if</span> (i.indexOf(<span class="hljs-string">'data'</span>)&gt;<span class="hljs-number">-1</span>)
            bindingHandler.attachBindings(node);
        <span class="hljs-keyword">if</span> (i === <span class="hljs-string">"data-component"</span>)
            componentHandler.initComponent(data.attributes[i], node);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data.children !== <span class="hljs-string">"undefined"</span>)
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i=<span class="hljs-number">0</span>; i&lt;data.children.length; i++) {
            <span class="hljs-built_in">var</span> child =createNode(data.children[i]);
            node.appendChild(child);
        }
    <span class="hljs-keyword">if</span> (data.text.length &gt; <span class="hljs-number">0</span>)
        node.appendChild(<span class="hljs-built_in">document</span>.createTextNode(decodeEntities(data.text)));
    <span class="hljs-keyword">return</span> node;
}


<span class="hljs-built_in">module</span>.exports = {
    <span class="hljs-attribute">isRendering</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> rendering;
    },
    <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ops,node</span>) </span>{
        <span class="hljs-built_in">var</span> t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"rendering start"</span>, t, ops);
        rendering = <span class="hljs-literal">true</span>;
        <span class="hljs-built_in">var</span> root = node ? <span class="hljs-attribute">node</span> : <span class="hljs-built_in">document</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i = <span class="hljs-number">0</span>; i &lt; ops.length; i++) {
            <span class="hljs-built_in">var</span> op = ops[i];
            <span class="hljs-keyword">switch</span> (op.t) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"remove"</span>:
                    <span class="hljs-built_in">var</span> node = root.querySelector(op.p),
                        <span class="hljs-built_in">parent</span> = node.parentNode ? <span class="hljs-attribute">node.parentNode</span> : root;
                    bindingHandler.detachBinding(node);
                    <span class="hljs-keyword">if</span> (node.hasAttribute(<span class="hljs-string">"data-component"</span>))
                        componentHandler.removeComponent(node);
                    <span class="hljs-built_in">parent</span>.removeChild(node);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"addNode"</span>:
                    <span class="hljs-built_in">var</span> newNode = createNode(op.n),
                        <span class="hljs-built_in">parent</span> = op.p.length &gt; <span class="hljs-number">0</span> ? root.querySelector(op.p) : root;
                    <span class="hljs-built_in">parent</span>.appendChild(newNode);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"replace"</span>:
                    <span class="hljs-built_in">var</span> newNode = createNode(op.n),
                        node = root.querySelector(op.p),
                        <span class="hljs-built_in">parent</span> = node.parentNode ? <span class="hljs-attribute">node.parentNode</span> : root;
                    bindingHandler.detachBinding(node);
                    <span class="hljs-keyword">if</span> (node.hasAttribute(<span class="hljs-string">"data-component"</span>))
                        componentHandler.removeComponent(node);
                    <span class="hljs-built_in">parent</span>.replaceChild(newNode, node);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"attrChanged"</span>:
                    root.querySelector(op.n).setAttribute(op.a, op.v);
                    <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"rendering stop"</span>, (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - t) / <span class="hljs-number">1000</span>);
        rendering = <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<hr>
<p>Generated <em>Wed Sep 14 2016 11:26:49 GMT+0200 (CEST)</em> from <a href="render.js" title="View in source">&#x24C8; render.js</a></p>
