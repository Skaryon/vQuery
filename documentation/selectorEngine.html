<pre><code class="lang-js"><span class="hljs-built_in">var</span> CssSelectorParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'css-selector-parser'</span>).CssSelectorParser,
    sparser = <span class="hljs-keyword">new</span> CssSelectorParser();

sparser.registerSelectorPseudos(<span class="hljs-string">'has'</span>);
sparser.registerNestingOperators(<span class="hljs-string">'&gt;'</span>, <span class="hljs-string">'+'</span>, <span class="hljs-string">'~'</span>);
sparser.registerAttrEqualityMods(<span class="hljs-string">'^'</span>, <span class="hljs-string">'$'</span>, <span class="hljs-string">'*'</span>, <span class="hljs-string">'~'</span>);
sparser.enableSubstitutes();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasMoreRules</span>(<span class="hljs-params">rules</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> rules.rule !== <span class="hljs-string">"undefined"</span> || <span class="hljs-keyword">typeof</span> rules.ruleSet !== <span class="hljs-string">"undefined"</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getNextRules</span>(<span class="hljs-params">rules</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> rules.ruleSet !== <span class="hljs-string">"undefined"</span>)
        <span class="hljs-keyword">return</span> rules.ruleSet;
    <span class="hljs-keyword">else</span>  <span class="hljs-keyword">return</span> rules.rule;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkClasses</span>(<span class="hljs-params">rules, node</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> rules.class === <span class="hljs-string">"undefined"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i=<span class="hljs-number">0</span>; i&lt;rules.class.length; i++) {
        <span class="hljs-keyword">if</span> (node.classNames.indexOf(rules.class[i]) === <span class="hljs-number">-1</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkTagName</span>(<span class="hljs-params">rules, node</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> rules.tagName === <span class="hljs-string">"undefined"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (rules.tagName === node.name)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;    
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkID</span>(<span class="hljs-params">rules, node</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> rules.id === <span class="hljs-string">"undefined"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (rules.id === node.id)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;    
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">traverseVDOM</span>(<span class="hljs-params">rules, currentVDOM, selectedNodes, exact</span>) </span>{
    <span class="hljs-built_in">var</span> hits = {
        <span class="hljs-attribute">tagName</span>: checkTagName(rules, currentVDOM),
        <span class="hljs-attribute">classNames</span>: checkClasses(rules, currentVDOM),
        <span class="hljs-attribute">id:</span><span class="hljs-string"> checkID</span>(rules, currentVDOM)
    }
    <span class="hljs-keyword">if</span> (hits.tagName &amp;&amp; hits.classNames &amp;&amp; hits.id) {
        <span class="hljs-keyword">if</span> (!hasMoreRules(rules)) {
            <span class="hljs-keyword">if</span> (selectedNodes.indexOf(currentVDOM) === <span class="hljs-number">-1</span>)
                selectedNodes.push(currentVDOM);
        }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i = <span class="hljs-number">0</span>; i &lt; currentVDOM.children.length; i++) {
                <span class="hljs-built_in">var</span> nextRules = getNextRules(rules);
                traverseVDOM(nextRules, currentVDOM.children[i], selectedNodes, nextRules.nestingOperator === <span class="hljs-string">"&gt;"</span>);
            }
    } <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">if</span> (!exact &amp;&amp; currentVDOM.children.length &gt; <span class="hljs-number">0</span>) 
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i=<span class="hljs-number">0</span>; i &lt; currentVDOM.children.length; i++)
                traverseVDOM(rules, currentVDOM.children[i], selectedNodes);
}

<span class="hljs-built_in">module</span>.exports.query = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">vDOM, selector</span>) </span>{
    <span class="hljs-built_in">var</span> parsedSelector = sparser.parse(selector),
        selectedNodes = [];
    <span class="hljs-keyword">if</span> (hasMoreRules(parsedSelector))
        traverseVDOM(getNextRules(parsedSelector), vDOM.children[<span class="hljs-number">0</span>], selectedNodes);
    <span class="hljs-keyword">return</span> selectedNodes;
}
</code></pre>
<hr>
<p>Generated <em>Wed Sep 14 2016 11:26:49 GMT+0200 (CEST)</em> from <a href="selectorEngine.js" title="View in source">&#x24C8; selectorEngine.js</a></p>
