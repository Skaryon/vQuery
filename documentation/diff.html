<pre><code class="lang-js"><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.prototype.filter) {
    <span class="hljs-built_in">Array</span>.prototype.filter = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fun<span class="hljs-comment">/*, thisArg*/</span></span>) </span>{
<span class="hljs-meta">        'use strict'</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span> === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>();
        }

        <span class="hljs-keyword">var</span> t = <span class="hljs-built_in">Object</span>(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">var</span> len = t.length &gt;&gt;&gt; <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fun !== <span class="hljs-string">'function'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>();
        }

        <span class="hljs-keyword">var</span> res = [];
        <span class="hljs-keyword">var</span> thisArg = <span class="hljs-built_in">arguments</span>.length &gt;= <span class="hljs-number">2</span> ? <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>] : <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
            <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> t) {
                <span class="hljs-keyword">var</span> val = t[i];
</code></pre>
<p>NOTE: Technically this should Object.defineProperty at
the next index, as push can be affected by
properties on Object.prototype and Array.prototype.
But that method&#39;s new, and collisions should be
rare, so use the more-compatible alternative.</p>
<pre><code class="lang-js">                <span class="hljs-keyword">if</span> (fun.call(thisArg, val, i, t)) {
                    res.push(val);
                }
            }
        }

        <span class="hljs-keyword">return</span> res;
    };
}
<span class="hljs-keyword">Array</span>.prototype.diff = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
    <span class="hljs-keyword">return</span> this.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span> </span>{<span class="hljs-keyword">return</span> a.indexOf(i) &lt; <span class="hljs-number">0</span>;});
};
<span class="hljs-keyword">Array</span>.prototype.unique = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> seen = {}
    <span class="hljs-keyword">return</span> this.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span> </span>{
        <span class="hljs-keyword">if</span> (seen[x])
            <span class="hljs-keyword">return</span>
        seen[x] = <span class="hljs-keyword">true</span>
        <span class="hljs-keyword">return</span> x
    })
};

<span class="hljs-comment">/**
 * Returns the CSS patch to a given DOM node.
 * <span class="hljs-doctag">@memberof</span> server#diff
 * <span class="hljs-doctag">@inner</span>
 * <span class="hljs-doctag">@param</span> {element} node DOM node.
 * <span class="hljs-doctag">@param</span> {immutableList} path Current path in the tree.
 * <span class="hljs-doctag">@returns</span> {string} CSS path
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPath</span><span class="hljs-params">(node, path)</span> </span>{
    <span class="hljs-keyword">if</span> (node.id)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#"</span> + node.id;
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> p = path.join(<span class="hljs-string">"&gt;"</span>).replace(/ /g, <span class="hljs-string">""</span>);
        <span class="hljs-keyword">if</span> (p.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">"&gt;"</span>)
            p = p.substring(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> p;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getParentPath</span><span class="hljs-params">(node, path)</span> </span>{
    <span class="hljs-keyword">var</span> p = node.parentNode,
        newPath = path.slice(<span class="hljs-number">0</span>);
    newPath.pop();
    <span class="hljs-keyword">if</span> (p &amp;&amp; p.id)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#"</span> + p.id;
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> p = newPath.join(<span class="hljs-string">"&gt;"</span>).replace(/ /g, <span class="hljs-string">""</span>);
        <span class="hljs-keyword">if</span> (p.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">"&gt;"</span>)
            p = p.substring(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> p;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addToPath</span><span class="hljs-params">(path, val)</span> </span>{
    <span class="hljs-keyword">var</span> newPath = path.slice(<span class="hljs-number">0</span>);
    newPath.push(val);
    <span class="hljs-keyword">return</span> newPath;
}

<span class="hljs-comment">/**
 * Diff algorithm. Generates a DOM patch.
 * <span class="hljs-doctag">@param</span> {document} oldDoc Old document.
 * <span class="hljs-doctag">@param</span> {document} doc New document.
 * <span class="hljs-doctag">@fires</span> diff.done
 * <span class="hljs-doctag">@returns</span> {Array} DOM patch to be send to the client.
 */</span>
module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(DOM1, DOM2, entry)</span> </span>{
    <span class="hljs-keyword">var</span> ops         = [],
        removals    = [];

    <span class="hljs-comment">/**
     * Helper function that iterates through both trees and compares nodes.
     * <span class="hljs-doctag">@memberof</span> server#diff
     * <span class="hljs-doctag">@inner</span>
     * <span class="hljs-doctag">@param</span> {element} oldNode Current node in oldDoc
     * <span class="hljs-doctag">@param</span> {element} newNode Current node in newDoc
     * <span class="hljs-doctag">@param</span> {immutableList} path Current path in the trees
     * <span class="hljs-doctag">@param</span> {integer} index The index of the nodes in the current tree level.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">helper</span><span class="hljs-params">(oldNode, newNode, path, index)</span> </span>{
</code></pre>
<p>check if there is the same kind of node in this position</p>
<pre><code class="lang-js">        <span class="hljs-keyword">if</span> (!(oldNode.name !== newNode.name || oldNode.text !== newNode.text)) {
            <span class="hljs-built_in">var</span> oldKeys = Object.keys(oldNode.attributes),
                newKeys = Object.keys(newNode.attributes),
                removed = oldKeys.<span class="hljs-built_in">diff</span>(newKeys),
                added   = newKeys.<span class="hljs-built_in">diff</span>(oldKeys),
                toCompare = newKeys.<span class="hljs-built_in">concat</span>(oldKeys).<span class="hljs-built_in">diff</span>(removed).<span class="hljs-built_in">diff</span>(added).<span class="hljs-built_in">unique</span>();

            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i = <span class="hljs-number">0</span>; i &lt; toCompare.<span class="hljs-built_in">length</span>; i++) {
                <span class="hljs-keyword">if</span> (newNode.attributes[toCompare[i]] !== oldNode.attributes[toCompare[i]]) {
                    ops.<span class="hljs-built_in">push</span>({
                        t: <span class="hljs-string">"attrChanged"</span>,
                        n: getPath(newNode, path),
                        a: toCompare[i],
                        v: newNode.attributes[toCompare[i]]
                    });
                }
            }
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i = <span class="hljs-number">0</span>; i &lt; added.<span class="hljs-built_in">length</span>; i++) {
                ops.<span class="hljs-built_in">push</span>({
                    t: <span class="hljs-string">"attrChanged"</span>,
                    n: getPath(newNode, path),
                    a: added[i],
                    v: newNode.attributes[added[i]]
                });
            }
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i = <span class="hljs-number">0</span>; i &lt; removed.<span class="hljs-built_in">length</span>; i++) {
                ops.<span class="hljs-built_in">push</span>({
                    t: <span class="hljs-string">"attrRemoved"</span>,
                    n: getPath(newNode, path),
                    a: removed[i]
                });
            }
            <span class="hljs-built_in">var</span> childIndizes = {},
                newChildren = typeof newNode.children !== <span class="hljs-string">"undefined"</span> ? newNode.children : [],
                oldChildren = typeof oldNode.children !== <span class="hljs-string">"undefined"</span> ? oldNode.children : [];
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">var</span> i = <span class="hljs-number">0</span>; i &lt; Math.<span class="hljs-built_in">max</span>(newChildren.<span class="hljs-built_in">length</span>, oldChildren.<span class="hljs-built_in">length</span>); i++) {
                <span class="hljs-built_in">var</span> oldChild = oldChildren[i];
                <span class="hljs-built_in">var</span> newChild = newChildren[i];
</code></pre>
<p>check if new Node is not in old doc -&gt; insert</p>
<pre><code class="lang-js">                <span class="hljs-keyword">if</span> (typeof oldChild === <span class="hljs-string">"undefined"</span>) {
                    var newPath = newChild.<span class="hljs-keyword">name</span> === <span class="hljs-string">"html"</span> ? <span class="hljs-built_in">path</span> : addToPath(<span class="hljs-built_in">path</span>, newChild.<span class="hljs-keyword">name</span> + <span class="hljs-string">":nth-child("</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">")"</span>);
                    ops.push({
                            t: <span class="hljs-string">"addNode"</span>,
                            p: getParentPath(newNode, newPath),
                            n: newChild
                        });
                } <span class="hljs-keyword">else</span> {
                    var newPath = oldChild.<span class="hljs-keyword">name</span> === <span class="hljs-string">"html"</span> ? <span class="hljs-built_in">path</span> : addToPath(<span class="hljs-built_in">path</span>, oldChild.<span class="hljs-keyword">name</span> + <span class="hljs-string">":nth-child("</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">")"</span>);
                    <span class="hljs-keyword">if</span> (typeof newChild === <span class="hljs-string">"undefined"</span>) {
                        removals.unshift({
                            t: <span class="hljs-string">"remove"</span>,
                            p: getPath(oldChild,newPath),
                            i: i
                        });
                    } <span class="hljs-keyword">else</span> {
                        helper(oldChild, newChild, newPath, i);
                    }
                }
            }
        } <span class="hljs-keyword">else</span> {
            ops.push({
                t: <span class="hljs-string">"replace"</span>,
                p: getPath(newNode, <span class="hljs-built_in">path</span>),
                n: newNode,
                i: index
            });
        }
    }
    helper(DOM1, DOM2,[entry], <span class="hljs-number">1</span>);
    return ops.concat(removals);
}
</code></pre>
<hr>
<p>Generated <em>Wed Sep 14 2016 11:26:49 GMT+0200 (CEST)</em> from <a href="diff.js" title="View in source">&#x24C8; diff.js</a></p>
